services:
    nginx:
        container_name: ${COMPOSE_PROJECT_NAME}_nginx
        image: nginx:alpine
        volumes:
            - ./nginx:/etc/nginx/templates
            - ./wordpress:/var/www/html
        ports:
            - '$WP_PORT:80'
        environment:
            - NUXT_NGINX_URL=${NUXT_NGINX_URL:-http://nuxt-app:3000}
        depends_on:
            - wordpress
        networks:
            - nuxt-network
    wordpress:
        container_name: ${COMPOSE_PROJECT_NAME}_wordpress
        image: wordpress:6.4.3-php8.1-fpm
        volumes:
            - ./wordpress:/var/www/html
        depends_on:
            - mysql
        environment:
            WORDPRESS_DB_HOST: mysql:3306
            WORDPRESS_DB_USER: $WP_MYSQL_USERNAME
            WORDPRESS_DB_PASSWORD: $WP_MYSQL_PASSWORD
            WORDPRESS_DB_NAME: $WP_MYSQL_DATABASE
            WORDPRESS_DEBUG: $WP_DEBUG
            NUXT_API_URL: ${NUXT_NGINX_URL:-http://nuxt-app:3000}
            WORDPRESS_CONFIG_EXTRA: 
                define('WP_SITEURL', '$WP_URL');
                define('WP_HOME', '$WP_URL');
                define('WP_MEMORY_LIMIT', '256M');
                define('WP_MAX_MEMORY_LIMIT', '256M');
                define('FS_METHOD', 'direct');
        networks:
            - nuxt-network
    # phpmyadmin:
    #     container_name: ${COMPOSE_PROJECT_NAME}_phpmyadmin
    #     image: phpmyadmin/phpmyadmin
    #     depends_on:
    #         - mysql
    #     environment:
    #         - PMA_HOST=mysql
    #         - PMA_ARBITRARY=1
    #         - UPLOAD_LIMIT=300M
    #     ports:
    #         - $WP_PORT_PHP_MY_ADMIN:80
    #     networks:
    #         - nuxt-network
    mysql:
        container_name: ${COMPOSE_PROJECT_NAME}_mysql-maria
        image: mariadb:10.5
        volumes: 
            - ./db:/docker-entrypoint-initdb.d
            #   uat及production用，本機開發請註解掉
            # - /db/${COMPOSE_PROJECT_NAME}/data:/var/lib/mysql 
            # - /db/${COMPOSE_PROJECT_NAME}/log:/var/log/mysql
        environment:
            MYSQL_ALLOW_EMPTY_PASSWORD: 'false'  # 不允許空密碼
            MYSQL_ROOT_PASSWORD: $WP_MYSQL_ROOT_PASSWORD
            MYSQL_DATABASE: $WP_MYSQL_DATABASE
            MYSQL_USER: $WP_MYSQL_USERNAME   # 指定新的使用者
            MYSQL_PASSWORD: $WP_MYSQL_PASSWORD # 指定新使用者的密碼
        networks:
            - nuxt-network
    # nuxt-app:
    #     container_name: ${COMPOSE_PROJECT_NAME}_app
    #     build: 
    #         context: ./nuxt-app
    #         args:
    #             NUXT_PORT: ${NUXT_PORT:-4001}
    #     image: ${COMPOSE_PROJECT_NAME}
    #     environment:
    #         - COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}
    #         - NUXT_PORT=${NUXT_PORT:-4001}
    #         - ENV=${ENV}
    #         - APP_NAME=${COMPOSE_PROJECT_NAME}
    #         - NUXT_SITE_URL=${NUXT_SITE_URL}
    #         - WP_URL=${WP_URL}
    #     ports:
    #         - "${NUXT_PORT:-4001}:${NUXT_PORT:-4001}"
    #     depends_on:
    #         - nginx
    #     networks:
    #         - nuxt-network
networks:
    nuxt-network: